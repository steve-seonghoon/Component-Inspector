<!DOCTYPE html>
<html>
<head>
  <style>
    /* 기본 변수 정의 */
    :root {
      /* 색상 */
      --color-text: var(--figma-color-text);
      --color-text-secondary: var(--figma-color-text-secondary);
      --color-bg: var(--figma-color-bg);
      --color-bg-secondary: var(--figma-color-bg-secondary);
      --color-border: var(--figma-color-border);
      --color-border-strong: var(--figma-color-border-strong);
      
      /* 간격 */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
      --spacing-xxl: 32px;
      
      /* 폰트 크기 */
      --font-xs: 10px;
      --font-sm: 11px;
      --font-md: 12px;
      --font-lg: 13px;
      --font-xl: 14px;
      
      /* 테두리 반경 */
      --radius-sm: 3px;
      --radius-md: 4px;
      --radius-lg: 6px;
    }

    /* 기본 스타일 */
    body {
      font-family: Inter, sans-serif;
      margin: 0;
      padding: 0;
      color: var(--color-text);
      background-color: var(--color-bg);
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* 공통 버튼 스타일 */
    .button {
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--radius-lg);
      font-size: var(--font-lg);
      cursor: pointer;
      border: none;
      transition: background-color 0.1s;
    }

    .button-primary {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .button-secondary {
      background: var(--color-bg-secondary);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    /* 카드 스타일 */
    .card {
      padding: var(--spacing-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      background: var(--color-bg);
      transition: border-color 0.1s;
    }

    .card:hover {
      border-color: var(--color-border-strong);
    }

    /* 뱃지 스타일 */
    .badge {
      font-size: var(--font-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      display: inline-block;
    }

    .badge-primary {
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
    }

    .badge-secondary {
      background: var(--color-bg-secondary);
      color: var(--color-text-secondary);
    }

    /* 레이아웃 유틸리티 */
    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .gap-sm {
      gap: var(--spacing-sm);
    }

    .gap-md {
      gap: var(--spacing-md);
    }

    /* 텍스트 스타일 */
    .text-sm {
      font-size: var(--font-sm);
    }

    .text-md {
      font-size: var(--font-md);
    }

    .text-secondary {
      color: var(--color-text-secondary);
    }

    /* 기존의 특정 컴포넌트 스타일은 유지하되 공통 변수 사용 */
    .screen {
      display: none;
      height: 100vh;
      overflow-y: auto;
      padding: var(--spacing-lg);
    }

    .screen.active {
      display: block;
    }

    #scanButton {
      width: 100%;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      height: 32px;
      margin-bottom: 12px;
    }

    .back-button {
      background: none;
      border: none;
      padding: 0;
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-arrow {
      font-size: 16px;
      line-height: 1;
    }

    .back-button:hover {
      color: var(--figma-color-text);
    }

    /* 스크롤바 관련 스타일 제거 */
    ::-webkit-scrollbar {
      display: none;
    }

    /* 컴포넌트 상세 페이지 스타일 수정 */
    .component-header {
      margin-bottom: 16px;
    }

    .component-library {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .library-name {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    .open-library {
      background: none;
      border: none;
      padding: 4px 8px;
      font-size: 12px;
      color: var(--figma-color-text-brand);
      cursor: pointer;
      border-radius: 4px;
    }

    .open-library:hover {
      background: var(--figma-color-bg-brand-tertiary);
    }

    .component-description {
      font-size: 12px;
      line-height: 1.5;
      color: var(--figma-color-text);
      background: var(--figma-color-bg-secondary);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .swap-section {
      margin-top: 32px;
    }

    .swap-section select {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
    }

    .swap-button {
      width: 100%;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--figma-color-text-onbrand);
      background: var(--figma-color-bg-brand);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .swap-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .instance-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .instance-item {
      padding: 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .instance-item:hover {
      border: 1px solid var(--figma-color-border-strong);
    }

    .component-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0; /* 버튼 영역은 축소되지 않도록 */
    }

    .instance-count {
      font-size: 12px;
      padding: 4px 8px;
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
      border-radius: 6px;
      cursor: pointer;
      min-width: 20px;
      text-align: center;
    }

    .instance-count:hover {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .edit-button {
      padding: 4px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      border-radius: 4px;
    }

    .edit-button:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    .divider {
      width: 1px;
      height: 16px;
      background: var(--figma-color-border);
    }

    .property-name {
      font-weight: 500;
      font-size: 11px;
    }

    .instance-count {
      font-size: 10px;
      background: var(--figma-color-bg-brand-tertiary);
      padding: 1px 6px;
      border-radius: 4px;
      min-width: 16px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .instance-count:hover {
      background-color: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .sub-list {
      margin: 6px 0;
      padding-left: 8px;
      border-left: 1px solid var(--figma-color-border);
    }

    .sub-list-item {
      margin: 4px 0;
    }

    .layer-name {
      font-size: 10px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .instance-properties {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .instance-property {
      font-size: 9px;
      color: var(--figma-color-text-secondary);
      background: var(--figma-color-bg-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      white-space: nowrap;
    }

    .show-more {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      background: none;
      border: none;
      padding: 2px 4px;
      margin: 2px 0;
      cursor: pointer;
      width: auto;
      text-decoration: underline;
    }

    .toast {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 1000;
    }

    .message {
      padding: 8px 12px;
      margin-bottom: 12px;
      border-radius: 4px;
    }

    .error {
      background-color: var(--figma-color-bg-danger);
      color: var(--figma-color-text-ondanger);
      border: 1px solid var(--figma-color-border-danger);
    }

    .success {
      background-color: var(--figma-color-bg-success);
      color: var(--figma-color-text-onsuccess);
      border: 1px solid var(--figma-color-border-success);
    }

    .debug {
      font-family: monospace;
      padding: 4px;
      margin: 2px 0;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      color: var(--figma-color-text);
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    select option {
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .component-name {
      font-size: 14px;
      color: var(--figma-color-text-primary);
      margin-bottom: 4px;
    }

    .toast.error {
      background-color: var(--figma-color-bg-danger);
      color: var(--figma-color-text-ondanger);
    }

    .toast.success {
      background-color: var(--figma-color-bg-success);
      color: var(--figma-color-text-onsuccess);
    }

    @keyframes toast-in-out {
      0% {
        transform: translate(-50%, 100%);
        opacity: 0;
      }
      15% {
        transform: translate(-50%, 0);
        opacity: 1;
      }
      85% {
        transform: translate(-50%, 0);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, 100%);
        opacity: 0;
      }
    }

    .hidden {
      display: none;
    }

    #mainScreen {
      padding: 16px 16px 0 16px;
      height: 100vh;
      overflow-y: auto;
      box-sizing: border-box;
    }

    #detailScreen {
      padding: 0px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #componentDetail {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .component-list {
      padding-bottom: 16px;
    }

    .component-list-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      margin-bottom: 8px;
      background: var(--figma-color-bg);
    }

    .component-preview {
      width: 80px;
      height: 80px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .component-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .component-info {
      flex: 1;
    }

    .component-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .component-meta {
      display: flex;
      gap: 8px;
      color: var(--figma-color-text-secondary);
      font-size: 12px;
    }

    .library-badge {
      padding: 2px 6px;
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
      border-radius: 4px;
      font-size: 11px;
    }

    .property-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .property-item {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }

    .action-button {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      border-radius: 4px;
    }

    .action-button:hover {
      background-color: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    .component-key {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      background: var(--figma-color-bg-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      white-space: nowrap;
    }

    .component-description {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      background: var(--figma-color-bg-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      white-space: nowrap;
    }

    .component-set-name {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      background: var(--figma-color-bg-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      white-space: nowrap;
    }

    .detail-header {
      position: sticky;
      top: 0;
      background: var(--figma-color-bg);
      margin: -16px 0 16px 0;
      padding: 12px 0;
      border-bottom: 1px solid var(--figma-color-border);
      flex-shrink: 0;
      z-index: 100;
    }

    .detail-header .back-button {
      margin-left: 16px;
    }

    .detail-content {
      padding: 16px;        /* 좌우 패딩 줄임 */
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .detail-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--figma-color-text);
      flex: 1;
    }

    /* 메인 리스트 스타일 수정 */
    .component-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.1s;
      margin-bottom: 8px;
    }

    .component-item:hover {
      border: 1px solid var(--figma-color-border-strong);
    }

    .component-item:last-child {
      margin-bottom: 0;
    }

    .component-info {
      flex: 1;
      min-width: 0; /* 텍스트 오버플로우 방지 */
    }

    .instance-name {
      font-weight: 500;
      font-size: 13px;
      margin: 0;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .library-name {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    .instance-count-header {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      padding: 4px 0;
    }

    /* 스타일 추가 */
    .library-badge {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .library-badge.external {
      background-color: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
    }

    .library-badge.local {
      background-color: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
      border: 1px solid var(--figma-color-border);
    }

    .badges-container {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .usage-badge {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: var(--figma-color-bg-tertiary);
      color: var(--figma-color-text-secondary);
    }

    .search-input {
      width: 100%;
      padding: 8px 12px;
      font-size: 13px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .search-input:focus {
      border-color: var(--figma-color-border-brand-strong);
      outline: none;
    }

    .search-input::placeholder {
      color: var(--figma-color-text-tertiary);
    }

    .modifications-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modification-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: var(--figma-color-bg);
      border-radius: 6px;
      overflow: hidden;
    }

    .modification-group.sub-layer {
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      margin-top: 4px;
    }

    .modification-group-header {
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text);
      margin-bottom: 2px;
    }

    .modification-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .modification-tag {
      font-size: 11px;
      padding: 1px 6px;  /* 메인 리스트의 instance-count와 동일한 패딩 */
      border-radius: 4px;
      white-space: normal;
      word-break: break-word;
      line-height: 1.4;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .modification-tag.no-change {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
    }

    /* 변경사항 그룹 스타일 수정 */
    .modification-group {
      margin-top: 4px;
    }

    .modification-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;  /* 태그 간격 줄임 */
    }

    /* 각 변경 타입별 태그 스타일 */
    .modification-tag.text-change {
      background: rgba(30, 84, 183, 0.08);
      color: #1E54B7;
    }

    .modification-tag.color-change {
      background: rgba(91, 95, 199, 0.08);
      color: #5B5FC7;
    }

    .modification-tag.size-change {
      background: rgba(214, 66, 66, 0.08);
      color: #D64242;
    }

    .modification-tag.visibility-change {
      background: rgba(110, 113, 117, 0.08);
      color: #6E7175;
    }

    .modification-tag.padding-change {
      background: rgba(183, 107, 30, 0.08);
      color: #B76B1E;
    }

    .modification-tag.effect-change {
      background: rgba(142, 68, 221, 0.08);
      color: #8E44DD;
    }

    .modification-tag.autolayout-direction,
    .modification-tag.autolayout-spacing,
    .modification-tag.autolayout-alignment,
    .modification-tag.autolayout-sizing {
      background: rgba(12, 143, 99, 0.08);
      color: #0C8F63;
    }

    .modification-tag.size-autolayout {
      background: #F0F1F3;
      color: #9EA1A5;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .modification-tag.style-change {
      background: var(--figma-color-bg-tertiary);
      color: var(--figma-color-text-secondary);
    }

    .modification-tag.size-autolayout .reset-button {
      display: none;
    }

    .scan-options {
      margin-bottom: 24px;
    }

    .scan-options h3 {
      font-size: 13px;
      margin: 0 0 12px 0;
      color: var(--figma-color-text);
    }

    .scan-button {
      width: 100%;
      padding: 8px 16px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
    }

    .scan-button:hover {
      background: var(--figma-color-bg-hover);
    }

    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--figma-color-bg);
      border-top-color: var(--figma-color-bg-brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: var(--figma-color-text);
      margin-top: 12px;
      font-size: 13px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .search-container {
      margin-bottom: 16px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
    }

    .component-preview {
      position: relative;
      width: 100%;          /* 전체 너비 사용 */
      height: 200px;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      margin: 16px 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      box-sizing: border-box;
    }

    .preview-image {
      max-width: 100%;      /* 컨테이너 크기에 맞춤 */
      max-height: 100%;     /* 컨테이너 크기에 맞춤 */
      width: auto;          /* 원본 크기 유지 */
      height: auto;         /* 원본 크기 유지 */
      object-fit: scale-down;
    }

    .preview-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--figma-color-text-secondary);
      font-size: 13px;
      padding: 32px;
      text-align: center;
    }

    .reset-button {
      width: 14px;
      height: 14px;
      padding: 2px;
      border-radius: 50%;
      border: none;
      background: none;
      cursor: pointer;
      color: inherit;
      opacity: 0.5;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 4px;
      }

    .reset-button:hover {
        opacity: 1;
      background: var(--figma-color-bg-hover);
    }

    /* 레이어 타입을 읽기 쉽게 변환하는 함수 */
    .layer-type {
      font-size: 10px;
      color: var(--figma-color-text-tertiary);
      background: var(--figma-color-bg-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 4px;
    }

    /* 섹션 스타일 */
    .section-title,
    .instance-count-header,
    .action-section h3 {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      padding: 8px 0;
      font-weight: normal;
      margin: 0;
    }

    /* 검색창 스타일 */
    .search-container {
      margin-bottom: 12px;
    }

    #searchInput {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      }

    #searchInput:focus {
      border-color: var(--figma-color-border-brand);
      outline: none;
      }

    /* 검색 관련 스타일 */
    .search-input-wrapper {
      position: relative;
      width: 100%;
      }

    #searchInput {
      width: 100%;
      padding: 8px 32px 8px 8px; /* 오른쪽 패딩 증가 */
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
    }

    .clear-button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--figma-color-text-tertiary);
      cursor: pointer;
      padding: 4px;
      font-size: 12px;
      display: none;
    }

    .clear-button:hover {
      color: var(--figma-color-text);
    }

    .count-badge {
      color: var(--figma-color-text-secondary);
      font-weight: normal;
    }

    .empty-state {
      text-align: center;
      color: var(--figma-color-text-secondary);
      padding: 24px 0;
      font-size: 13px;
      display: none;
    }

    /* 썸네일 스타일 수정 */
    .component-thumbnail {
      width: 48px;
      height: 48px;
      border-radius: 4px;
      background: var(--figma-color-bg-secondary);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 4px;
      border: 1px solid var(--figma-color-border);
      transition: border-color 0.1s;
    }

    .component-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* 컴포넌트 타입 뱃지 스타일 추가 */
    .component-type-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--figma-color-bg-tertiary);
      color: var(--figma-color-text-secondary);
    }

    /* 기존 뱃지들의 스타일도 통일 */
    .library-badge, .usage-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* 복제 버튼 스타일 추가 */
    .clone-button {
      width: 100%;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }

    .clone-button:hover {
      background: var(--figma-color-bg-hover);
    }

    /* 스왑 화면 스타일 */
    #swapScreen {
      display: none;
      height: 100vh;
      background: var(--figma-color-bg);
    }

    .swap-header {
      padding: 16px;
      border-bottom: 1px solid var(--figma-color-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .swap-title {
      font-size: 13px;
      font-weight: 500;
    }

    .swap-list {
      padding: 8px 16px;
    }

    .swap-item {
      padding: 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.1s;
    }

    .swap-item:hover {
      background: var(--figma-color-bg-hover);
    }

    .swap-item-thumbnail {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .swap-item-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .swap-item-info {
      flex: 1;
      min-width: 0;
    }

    .swap-item-name {
      font-size: 13px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .swap-search {
      padding: 16px 16px 8px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .swap-search input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    /* 액션 버튼 섹션 스타일 */
    .action-section {
      margin: 0px;
      padding: 0px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    /* 인스턴스 섹션 헤더 스타일 */
    .instance-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-modifications {
      font-size: 12px;
      color: var(--figma-color-text-brand);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
    }

    .toggle-modifications:hover {
      background: var(--figma-color-bg-hover);
      border-radius: 4px;
    }

    /* 수정된 속성 숨김/표시 스타일 수정 */
    .modifications-hidden .modifications-list {
      display: none;
    }

    /* 프로퍼티는 항상 표시 */
    .property-list,
    .variant-property {
      display: block;
    }

    /* 공통 버튼 스타일 */
    .scan-button,
    .swap-button,
    .clone-button {
      width: 100%;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
      margin: 0px
    }

    .scan-button:hover,
    .swap-button:hover,
    .clone-button:hover {
      background: var(--figma-color-bg-hover);
    }

    /* 버튼 그룹 스타일 */
    .scan-buttons,
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;  /* 버튼 사이 간격 */
      margin: 0px;
    }

    /* 섹션 스타일 */
    .scan-section,
    .action-section {
      margin-bottom: 16px;
      padding: 0px;
    }

    /* variant 속성 스타일 추가 */
    .variant-property {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      background: var(--figma-color-bg-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      margin-top: 4px;
    }

    .component-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .component-tag {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      background: var(--figma-color-bg-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      white-space: nowrap;
    }

    /* 변경사항 태그 스타일 */
    .modification-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--figma-color-text-danger);
      background: var(--figma-color-bg-danger-tertiary);
      padding: 1px 4px;
      border-radius: 3px;
      margin-right: 4px;
      margin-top: 4px;
    }

    .reset-button {
      width: 14px;
      height: 14px;
      padding: 2px;
      border-radius: 50%;
      border: none;
      background: none;
      cursor: pointer;
      color: inherit;
      opacity: 0.5;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reset-button:hover {
      opacity: 1;
      background: var(--figma-color-bg-danger);
      color: var(--figma-color-text-ondanger);
    }

    /* notification 스타일만 유지 */
    .notification {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .notification.success {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onsuccess);
    }

    .notification.error {
      background: var(--figma-color-bg-danger);
      color: var(--figma-color-text-ondanger);
    }

    .notification.loading {
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .notification-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--figma-color-bg-brand-tertiary);
      border-top-color: var(--figma-color-bg-brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .notification-message {
      font-size: 13px;
    }

    .instances-container {
      padding: 16px;
    }

    .instances-container .header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .back-button {
      margin-right: 8px;
      padding: 4px 0px;
      border: none;
      color: var(--figma-color-text);
      border-radius: 4px;
      cursor: pointer;
    }

    /* 컴포넌트 선택 화면 스타일 */
    .component-select-screen {
      padding: 16px;
      }

    .search-container input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .component-info {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    .instance-page {
      margin-top: 0px;
      margin-bottom: var(--spacing-sm);
    }
  </style>
</head>
<body>
  <div id="mainScreen" class="screen active">
    <!-- 스캔 범위 선택 섹션 -->
    <div class="scan-section">
      <h3 class="section-title">스캔 범위 선택</h3>
      <div class="scan-buttons">
        <button class="scan-button" id="scanAll">
          전체 파일 스캔
        </button>
        <button class="scan-button" id="scanCurrentPage">
          현재 페이지 스캔
        </button>
        <button class="scan-button" id="scanSelection">
          선택된 레이어 스캔
        </button>
      </div>
    </div>

    <!-- 검색 및 결과 섹션 -->
    <div class="results-section">
      <h3 class="section-title">스캔 결과 <span id="componentCount" class="count-badge"></span></h3>
      <div class="search-container">
        <div class="search-input-wrapper">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="컴포넌트 이름으로 검색" 
            oninput="filterComponents(this.value)"
          >
          <button 
            id="clearSearch" 
            class="clear-button" 
            onclick="clearSearch()" 
            style="display: none;"
          >
            ✕
          </button>
        </div>
      </div>
      <div class="loading-indicator" style="display: none;">스캔 중...</div>
      <div class="empty-state">검색된 컴포넌트가 없습니다.</div>
      <div class="component-list">
        <div id="componentList"></div>
      </div>
    </div>
  </div>

  <div id="detailScreen" class="screen">
    <div id="componentDetail"></div>
  </div>

  <!-- 스왑 화면 -->
  <div id="swapScreen" class="screen" style="display: none;">
    <div class="header">
      <button onclick="goBack()" class="back-button">← 뒤로</button>
      <h2>교체할 컴포넌트 선택</h2>
    </div>
    
    <div class="search-container">
      <input 
        type="text" 
        id="swapSearchInput" 
        placeholder="컴포넌트 검색..."
        oninput="filterSwapComponents(this.value)"
      >
    </div>
    
    <div class="component-list" id="swapList">
      <!-- 스왑 가능한 컴포넌트 목록이 여기에 표시됩니다 -->
    </div>
  </div>

  <button id="backButton">뒤로가기</button>

  <div id="componentListScreen" class="screen">
    <div class="component-list-container">
      <div class="empty-state" style="display: none;">
        <p>컴포넌트를 찾을 수 없습니다.</p>
      </div>
      <div class="component-list"></div>
    </div>
  </div>

  <!-- 인스턴스 목록 화면 -->
  <div id="instancesScreen" class="screen" style="display: none;">
    <div class="header">
      <button onclick="goBack()" class="back-button">← 뒤로</button>
      <h2>인스턴스 교체</h2>
    </div>
    <div class="instances-list"></div>
  </div>

  <!-- 컴포넌트 선택 화면 추가 -->
  <div id="component-select-screen" class="screen" style="display: none;">
    <div class="header">
      <button onclick="goBack()" class="back-button">← 뒤로</button>
      <h2>교체할 컴포넌트 선택</h2>
    </div>
    
    <div class="search-container">
      <input 
        type="text" 
        id="componentSearchInput" 
        placeholder="컴포넌트 검색..."
        oninput="filterComponents(this.value)"
      >
    </div>
    
    <div class="component-list" id="swapComponentList"></div>
  </div>

<script>
    // 전역 변수 선언
    let toastTimeout;
    let allComponents = [];
    let mainScreen = document.getElementById('mainScreen');
    let detailScreen = document.getElementById('detailScreen');
    let scanStartTime;
    let scanTimer;
    let notificationTimeout = null;

    // 스캔 버튼 이벤트 리스너 등록
    document.getElementById('scanAll').addEventListener('click', () => scanComponents('all'));
    document.getElementById('scanCurrentPage').addEventListener('click', () => scanComponents('current-page'));
    document.getElementById('scanSelection').addEventListener('click', () => scanComponents('selection'));

    function scanComponents(scanType) {
      // 기존 알림 제거
      hideNotification();
      
      // 컴포넌트 목록 초기화
      const componentList = document.querySelector('.component-list');
      if (componentList) {
        componentList.innerHTML = '';
      }
      
      // 빈 상태 메시지 숨기기
      const emptyState = document.querySelector('.empty-state');
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      // 로딩 상태 표시
      showNotification('컴포넌트 스캔 중...', 'loading');
      
      // 플러그인에 스캔 요청 메시지 전송
      parent.postMessage({ 
        pluginMessage: { 
          type: 'scan-components',
          scanType: scanType
        }
      }, '*');
    }

    // 메시지 핸들러 수정
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      console.log('Received message:', msg); // 디버깅을 위한 로그 추가

      if (msg.type === 'component-list') {  // 메시지 타입 변경
        const componentList = document.querySelector('.component-list');
        if (!componentList) {
          console.error('Component list element not found');
          return;
        }

        if (!msg.components || msg.components.length === 0) {
          componentList.innerHTML = '<div class="empty-state">검색된 컴포넌트가 없습니다.</div>';
          return;
        }

        componentList.innerHTML = '';
        
        msg.components.forEach(item => {  // hierarchy 대신 components 사용
          const listItem = document.createElement('div');
          listItem.className = 'component-list-item';

          // 프리뷰 이미지
          const previewDiv = document.createElement('div');
          previewDiv.className = 'component-preview';
          if (item.preview) {
            const img = document.createElement('img');
            img.src = item.preview;
            img.alt = item.name;
            previewDiv.appendChild(img);
          }
          listItem.appendChild(previewDiv);

          // 컴포넌트 정보
          const infoDiv = document.createElement('div');
          infoDiv.className = 'component-info';

          // 컴포넌트 이름
          const nameDiv = document.createElement('div');
          nameDiv.className = 'component-name';
          nameDiv.textContent = item.name;
          infoDiv.appendChild(nameDiv);

          // 메타 정보
          const metaDiv = document.createElement('div');
          metaDiv.className = 'component-meta';

          // 사용 횟수
          const usageDiv = document.createElement('div');
          usageDiv.textContent = item.type === 'set' 
            ? `${item.componentSet.totalUsageCount}회 사용됨` 
            : `${item.usageCount}회 사용됨`;
          metaDiv.appendChild(usageDiv);

          // 외부 라이브러리 뱃지
          if (item.isExternalLibrary) {
            const libraryBadge = document.createElement('div');
            libraryBadge.className = 'library-badge';
            libraryBadge.textContent = '외부 라이브러리';
            metaDiv.appendChild(libraryBadge);
          }

          infoDiv.appendChild(metaDiv);
          listItem.appendChild(infoDiv);
          componentList.appendChild(listItem);
        });
      }
    };

    function updateComponentList(components) {
      const componentList = document.querySelector('.component-list');
      const emptyState = document.querySelector('.empty-state');
      
      if (components.length === 0) {
        emptyState.style.display = 'block';
        componentList.innerHTML = '';
      } else {
        emptyState.style.display = 'none';
        const html = components.map(comp => `
          <div class="component-item" 
            onclick="showComponentDetail(${JSON.stringify(comp).replace(/"/g, '&quot;')})"
          >
            <div class="component-thumbnail">
              ${comp.preview ? 
                `<img src="${comp.preview}" alt="${comp.name}" />` : 
                '<div class="placeholder"></div>'
              }
            </div>
            <div class="component-info">
              <div class="instance-name">${comp.componentSet ? comp.componentSetName : comp.name}</div>
              <div class="badges-container">
                <div class="component-type-badge">
                  ${comp.componentSet ? '컴포넌트 세트' : '단일 컴포넌트'}
                </div>
                <div class="library-badge ${comp.libraryName === 'Local Component' ? 'local' : 'external'}">
                  ${comp.libraryName === 'Local Component' ? '로컬 라이브러리' : '외부 라이브러리'}
                </div>
                <div class="usage-badge">
                  ${comp.instanceCount}회 사용
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        componentList.innerHTML = html;
      }

      // 초기 카운트 업데이트
      updateComponentCount(components.length, components.length);
      
      // 로딩 인디케이터 숨기기
      document.querySelector('.loading-indicator').style.display = 'none';
    }

    function updateComponentCount(visibleCount, totalCount) {
      const countBadge = document.getElementById('componentCount');
      if (countBadge) {
        countBadge.textContent = visibleCount === totalCount ? 
          `총 ${totalCount}개` : 
          `${visibleCount} / ${totalCount}`;
      }
    }

    function selectInstances(instanceIds) {
      console.log('UI: Sending instanceIds:', instanceIds);
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-instances',
          instanceIds: instanceIds
        }
      }, '*');
    }

    function showComponentDetail(comp) {
      const safeComp = JSON.parse(JSON.stringify(comp));
      const detailScreen = document.getElementById('detailScreen');
      
      // 외부 라이브러리 컴포넌트인 경우에만 복제 버튼 표시
      const cloneButton = safeComp.libraryName !== 'Local Component' ? `
        <button class="clone-button" onclick="cloneMainComponent('${safeComp.mainComponentId}', ${!!safeComp.componentSet})">
          메인 컴포넌트 복제
        </button>
      ` : '';

      detailScreen.innerHTML = `
        <div class="detail-header">
          <button class="back-button" onclick="showMainScreen()">
            <span class="back-arrow">〈</span>
            뒤로가기
          </button>
        </div>

        <div class="detail-content">
          <!-- 컴포넌트 이름 -->
          <div class="component-header">
            <div class="component-name">${safeComp.componentSet ? safeComp.componentSetName : safeComp.name}</div>
            <div class="badges-container">
              <div class="component-type-badge">
                ${safeComp.componentSet ? '컴포넌트 세트' : '단일 컴포넌트'}
              </div>
              <div class="library-badge ${safeComp.libraryName === 'Local Component' ? 'local' : 'external'}">
                ${safeComp.libraryName === 'Local Component' ? '로컬 라이브러리' : '외부 라이브러리'}
              </div>
              <div class="usage-badge">
                ${safeComp.instanceCount}회 사용
              </div>
            </div>
          </div>

          <!-- 미리보기 섹션 -->
          <div class="component-preview">
            ${safeComp.preview ? 
              `<img class="preview-image" 
                   src="${safeComp.preview}" 
                   alt="Component preview" 
                   onload="console.log('[UI] Image loaded:', this.src.substring(0, 100) + '...')"
                   onerror="console.error('[UI] Image load failed:', this.src.substring(0, 100) + '...'); 
                     this.style.display='none'; 
                     this.nextElementSibling.style.display='flex';">
               <div class="preview-placeholder" style="display: none;">프리뷰를 불러올 수 없습니다.</div>` :
              `<div class="preview-placeholder">프리뷰를 불러올 수 없습니다.</div>`
            }
          </div>

          <!-- 액션 섹션 -->
          <div class="action-section">
            <h3>사용 가능한 동작</h3>
            <div class="action-buttons">
              <button class="swap-button" onclick="showSwapScreen('${safeComp.mainComponentId}', '${safeComp.name.replace(/'/g, "\\'")}')">
                전체 인스턴스 교체
              </button>
              ${cloneButton}
              <button 
                class="button button-secondary" 
                onclick="window.parent.postMessage({ 
                  pluginMessage: { 
                    type: 'GO_TO_MAIN_COMPONENT',
                    mainComponentId: '${safeComp.mainComponentId}',
                    instanceId: '${safeComp.id}'
                  } 
                }, '*')">
                메인 컴포넌트 바로가기
              </button>
            </div>
          </div>

          <!-- 인스턴스 목록 -->
          <div class="instances-section">
            <div class="instance-count-header">인스턴스 목록 (${safeComp.instanceCount})</div>
            <div class="instance-list">
              ${safeComp.instances.map(instance => {
                const propertiesHTML = instance.properties ? `
                  <div class="property-item">
                    ${instance.properties}
                  </div>
                ` : '';
                
                return `
                  <div class="instance-item" data-instance-id="${instance.id}" onclick="selectInstance('${instance.id}')">
                    <div class="instance-name">${instance.name}</div>
                    <div class="instance-page text-sm text-secondary">
                      Page: ${instance.pageName}
                    </div>
                    ${propertiesHTML ? `
                      <div class="property-list">
                        ${propertiesHTML}
                      </div>
                    ` : ''}
                    ${instance.modifications && instance.modifications.length > 0 ? `
                      <div class="modifications-list">
                        ${generateModificationsHTML(instance.modifications, instance.id)}
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      mainScreen.classList.remove('active');
      detailScreen.classList.add('active');
    }

    // 변경사항 토글 함수 수정
    function toggleModifications() {
      const instanceList = document.querySelector('.instance-list');
      const toggleButton = document.querySelector('.toggle-modifications');
      const isHidden = instanceList.classList.contains('modifications-hidden');
      
      instanceList.classList.toggle('modifications-hidden');
      toggleButton.textContent = isHidden ? '변경사항 간단히 보기' : '변경사항 자세히 보기';
    }

    function showMainScreen() {
      const mainScreen = document.getElementById('mainScreen');
      const detailScreen = document.getElementById('detailScreen');

      detailScreen.classList.remove('active');
      mainScreen.classList.add('active');
    }

    function swapComponent(currentComponentId, newComponentId) {
      console.log('[UI] Attempting to swap component:', {
        currentComponentId,
        newComponentId
      });

      if (currentComponentId && newComponentId) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'swap-component',
            currentComponentId,
            newComponentId
          }
        }, '*');
        
        console.log('[UI] Swap message sent to plugin');
        
        // 스왑 화면 닫기
        hideSwapScreen();
      } else {
        console.warn('[UI] Swap cancelled - missing component IDs');
      }
    }

    // 프로퍼티 값 포맷팅 함수 추가
    function formatPropertyValue(prop) {
      switch (prop.type) {
        case 'BOOLEAN':
          return prop.value ? 'Yes' : 'No';
        case 'INSTANCE_SWAP':
          return prop.value.split(',')[0];  // 첫 번째 값만 표시
        default:
          return prop.value;
      }
    }

    function toggleMore(button) {
      const compId = button.getAttribute('data-id');
      const total = parseInt(button.getAttribute('data-total'));
      const items = document.querySelectorAll(`[data-more="${compId}"]`);
      const isExpanded = button.textContent === '접기';
      
      items.forEach(item => {
        item.classList.toggle('hidden');
      });
      
      button.textContent = isExpanded ? 
        `${total - 2}개 더보기` : 
        '접기';
    }

    function getLibraryName(comp) {
      const libraryName = comp.name.split('/')[0];
      return libraryName || 'Local Component';
    }

    function openMainComponent(libraryId) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'open-main-component',
          libraryId 
        }
      }, '*');
    }

    function selectMainComponent(componentId) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-main-component',
          componentId 
        }
      }, '*');
    }

    function selectInstance(instanceId) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-instance',
          instanceId 
        }
      }, '*');
    }

    function updateComponentList(components) {
      const componentList = document.querySelector('.component-list');
      const emptyState = document.querySelector('.empty-state');
      
      if (components.length === 0) {
        emptyState.style.display = 'block';
        componentList.innerHTML = '';
      } else {
        emptyState.style.display = 'none';
        const html = components.map(comp => `
          <div class="component-item" 
            onclick="showComponentDetail(${JSON.stringify(comp).replace(/"/g, '&quot;')})"
          >
            <div class="component-thumbnail">
              ${comp.preview ? 
                `<img src="${comp.preview}" alt="${comp.name}" />` : 
                '<div class="placeholder"></div>'
              }
            </div>
            <div class="component-info">
              <div class="instance-name">${comp.componentSet ? comp.componentSetName : comp.name}</div>
              <div class="badges-container">
                <div class="component-type-badge">
                  ${comp.componentSet ? '컴포넌트 세트' : '단일 컴포넌트'}
                </div>
                <div class="library-badge ${comp.libraryName === 'Local Component' ? 'local' : 'external'}">
                  ${comp.libraryName === 'Local Component' ? '로컬 라이브러리' : '외부 라이브러리'}
                </div>
                <div class="usage-badge">
                  ${comp.instanceCount}회 사용
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        componentList.innerHTML = html;
      }

      // 초기 카운트 업데이트
      updateComponentCount(components.length, components.length);
      
      // 로딩 인디케이터 숨기기
      document.querySelector('.loading-indicator').style.display = 'none';
    }

    function swapAllComponents() {
      const librarySelect = document.getElementById('librarySelect');
      const componentSelect = document.getElementById('componentSelect');
      
      if (!componentSelect.value) return;

      parent.postMessage({ 
        pluginMessage: { 
          type: 'swap-all-components',
          newComponentId: componentSelect.value
        }
      }, '*');
    }

    function filterComponents(searchText) {
      const componentList = document.querySelector('.component-list');
      const components = componentList.getElementsByClassName('component-item');
      const clearButton = document.getElementById('clearSearch');
      const emptyState = document.querySelector('.empty-state');
      
      // X 버튼 표시/숨김
      clearButton.style.display = searchText ? 'block' : 'none';
      
      let visibleCount = 0;
      
      for (const component of components) {
        // instance-name 클래스를 가진 요소에서 텍스트 찾기
        const nameElement = component.querySelector('.instance-name');
        if (nameElement) {
          const name = nameElement.textContent.toLowerCase();
          const matches = name.includes(searchText.toLowerCase());
          component.style.display = matches ? 'block' : 'none';
          if (matches) visibleCount++;
        }
      }

      // 검색 결과 카운트 업데이트
      updateComponentCount(visibleCount, components.length);
      
      // 빈 상태 메시지 표시/숨김
      emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
      componentList.style.display = visibleCount === 0 ? 'none' : 'block';
    }

    function resetModification(event, instanceId, layerName, modificationType) {
      event.stopPropagation();  // 상위 클릭 이벤트 전파 방지
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'reset-modification',
          instanceId,
          layerName,
          modificationType
        }
      }, '*');
    }

    // 변경사항을 레이어별로 그룹화하는 함수
    function generateModificationsHTML(modifications, instanceId) {
      if (!modifications || modifications.length === 0) {
        return '<div class="modification-tag no-change">변경사항 없음</div>';
      }

      return modifications.map(mod => {
        const type = mod.type;
        const description = mod.description;
        const layerName = mod.layerName ? `[${mod.layerName}] ` : '';
        
        return `
          <div class="modification-tag ${type.toLowerCase()}-change">
            ${layerName}${description}
            <button 
              class="reset-button" 
              onclick="resetModification(event, '${instanceId}', '${mod.layerName || ''}', '${type}')"
              title="변경사항 초기화"
            >
              ↺
            </button>
          </div>
        `;
      }).join('');
    }

    // Base64를 Blob으로 변환하는 유틸리티 함수
    function base64ToBlob(base64, type) {
      const binaryString = window.atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      
      return new Blob([bytes], { type });
    }

    function showNotification(message, type = 'success', timeout) {
      // 기존 알림 제거
      hideNotification();
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      if (type === 'loading') {
        notification.innerHTML = `
          <div class="notification-spinner"></div>
          <div class="notification-message">${message}</div>
        `;
      } else {
        notification.innerHTML = `
          <div class="notification-message">${message}</div>
        `;
      }
      
      document.body.appendChild(notification);
      
      // loading 타입이 아닐 경우에만 자동으로 숨김
      if (type !== 'loading' && timeout) {
        notificationTimeout = window.setTimeout(() => {
          hideNotification();
        }, timeout);
      }
    }

    function hideNotification() {
      if (notificationTimeout) {
        clearTimeout(notificationTimeout);
        notificationTimeout = null;
      }
      
      const notification = document.querySelector('.notification');
      if (notification) {
        notification.remove();
      }
    }

    // 전체 인스턴스 교체 함수 추가
    function showSwapScreen(componentId) {
      console.log('Showing swap screen for component:', componentId);
      
      // 현재 화면 숨기기
      document.getElementById('detailScreen').classList.remove('active');
      
      // 스왑 화면 표시
      const swapScreen = document.getElementById('swapScreen');
      swapScreen.style.display = 'block';
      
      // 현재 선택된 컴포넌트 ID 저장
      window.selectedComponentId = componentId;
      
      // 교체 가능한 컴포넌트 목록 요청
      parent.postMessage({ 
        pluginMessage: { 
          type: 'get-available-components'
        } 
      }, '*');
    }

    // 메인 컴포넌트 복제 함수 추가
    function cloneMainComponent(componentId) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'clone-main-component',
          componentId: componentId 
        } 
      }, '*');
    }

    function handleSwapInstance(instanceId) {
      // 컴포넌트 선택 화면으로 전환
      showComponentSelectScreen(instanceId);
    }

    function goBack() {
      // 화면 전환
      document.getElementById('instancesScreen').style.display = 'none';
      document.getElementById('componentListScreen').style.display = 'block';
      
      parent.postMessage({
        pluginMessage: {
          type: 'goBack'
        }
      }, '*');
    }

    // 컴포넌트 선택 화면 표시
    function showComponentSelectScreen(instanceId) {
      document.getElementById('instancesScreen').style.display = 'none';
      document.getElementById('component-select-screen').style.display = 'block';
      
      // 현재 선택된 인스턴스 ID 저장
      window.selectedInstanceId = instanceId;
      
      // 컴포넌트 목록 요청
      parent.postMessage({
        pluginMessage: {
          type: 'get-available-components'
        }
      }, '*');
    }

    // 컴포넌트 교체 실행
    function handleComponentSelect(newComponentId) {
      if (!window.selectedInstanceId) return;
      
      // 인스턴스 목록 화면으로 전환
      const swapScreen = document.getElementById('swapScreen');
      const instancesScreen = document.getElementById('instancesScreen');
      
      if (swapScreen) swapScreen.style.display = 'none';
      if (instancesScreen) instancesScreen.style.display = 'block';
      
      // 인스턴스 목록 요청
      parent.postMessage({
        pluginMessage: {
          type: 'show-swap-screen',
          componentId: window.selectedInstanceId,
          newComponentId: newComponentId
        }
      }, '*');
    }

    // 버튼 클릭 이벤트 리스너 추가
    document.addEventListener('click', function(event) {
      if (event.target.id === 'navigateToMainBtn') {
        const componentId = event.target.dataset.componentId;
        parent.postMessage({
          pluginMessage: {
            type: 'navigate-to-main-component',
            componentId: componentId
          }
        }, '*');
      }
    });
</script>
</body>
</html>